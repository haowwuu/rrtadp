<!doctype html>
<html>
  <head>
    
    <title>人人投广告管理平台</title>
	<meta charset="utf-8">
	<meta http-equiv="keywords" content="dsp,contents,service">
	<meta http-equiv="description" content="dsp main page">
	<meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	
	<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="css/jquery.dataTables.min.css" />
	<link rel="stylesheet" type="text/css" href="css/dataTables.bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/jquery-ui.css" />
	<link rel="stylesheet" type="text/css" href="css/dsp.css" />
	
	
	
	<script type="text/javascript" src="js/jquery-1.12.3.js"></script>
	
	<script type="text/javascript" src="js/jquery.dataTables.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	<script type="text/javascript" src="js/dataTables.bootstrap.min.js"></script>	
	<script type="text/javascript" src="js/jquery-ui.js"></script>
	<script type="text/javascript" src="js/jquery.md5.js"></script>
	  <script src="https://cdn.bootcss.com/jquery.form/4.2.2/jquery.form.min.js"></script>
  </head>
  
  <body>
 	<div class="container">
	    <div id="confirmModal" class="modal fade in" style="z-index:80;">
	        <div class="modal-dialog modal-content" style="margin-top:5%; width:400px;">
	            <div class="modal-header" style="background-color: #428bca; padding: 3px 10px;" ><strong>确定删除数据?</strong></div>
	            <div class="modal-body container-fluid">
	                <p class="confirm-content"></p>
	            </div>
	            <div class="modal-footer" style="padding:5px 15px;">
	                <button name="submit" class="btn btn-primary">确认</button>
	                <button class="btn btn-default" data-dismiss="modal">取消</button>
	            </div>
	        </div>
	    </div>
	</div>
	
  	<div class="container">
  		<div id="modal" class="modal fade in" style="z-index:80;">
  			<div class="modal-dialog modal-content" style="margin-top:5%; width:800px;">
		  		<div class="modal-header" style="background-color: #428bca; padding: 10px 10px;">
		  			<!-- <button class="close" style="padding: 0 10px 20px 10px;" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>  -->
		  			<!-- <h4>application title</h4> -->
		  		</div>
		  		<div class="modal-body container-fluid">
		  			<form id="applicationForm" class="form-horizontal" role="form" enctype="multipart/form-data">
						<div class="form-group has-feedback" style="display: none;">
							<label class="col-sm-2 control-label">编号：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="hidden" name="appId">
								<input type="text" class="form-control" name="id" regx="^\S{2,25}$" title="应用名称:2-25个字符组成">
							</div>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">名称：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="name" regx="^\S{1,10}$" title="管理员:1-10个字符组成">
							</div>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">底价：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="basePrice" regx="^\S{2,50}$" title="应用地址:2-50个字符组成">
							</div>
						</div>
						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">地址：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="address" >
							</div>
						</div>

						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">设备标签：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="keyWords">
							</div>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">经度：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="lng">
							</div>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">纬度：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="lat">
							</div>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">描述：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="description">
							</div>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">行政区划代码：</label>
							<div class="col-sm-7 rf-no-padding">
								<input type="text" class="form-control" name="districtCode">
							</div>
						</div>
						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">设备封面：</label>
							<div class="col-sm-7">
								<div class="col-sm-7">
									<div style="width: 80px;height: 80px;position: relative;">
										<img src="images/add_img.png" id="devicePictureImg"
											 style="height:80px;width: 80px;position: absolute;left:0;top:0;"/>
										<input type="file"
											   style="border:none;height:80px;width: 80px;opacity: 0;position: absolute;left:0;top:0;"
											   class="form-control" name="devicePicture0" >
									</div>
								</div>
							</div>
						</div>
		  			</form>
		  		</div>
		  		<div class="modal-footer" style="padding:5px 15px;">
		  			<button name="submit" class="btn btn-primary">保存</button>
		  			<button class="btn btn-default" data-dismiss="modal">取消</button>
		  		</div>
	  		</div>
  		</div>

		<div id="detailModal" class="modal fade in" >
			<div class="modal-dialog modal-content" style="margin-top:5%; width:800px;">
				<div class="modal-header" style="background-color: #428bca; padding: 10px 10px;">
					<!-- <button class="close" style="padding: 0 10px 20px 10px;" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>  -->
					<!-- <h4>application title</h4> -->
				</div>
				<div class="modal-body container-fluid">
					<form class="form-horizontal" role="form" enctype="multipart/form-data">
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">ID：</label>
							<span class="col-sm-7 control-label" style="text-align: left;" name="id"></span>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">名称：</label>
							<span class="col-sm-7 control-label" style="text-align: left;" name="name"></span>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">底价：</label>
							<span class="col-sm-7 control-label" name="basePrice" style="text-align: left;" ></span>
						</div>
						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">地址：</label>
							<span class="col-sm-7 control-label" name="address" style="text-align: left;" ></span>
						</div>

						<div class="form-group has-feedback">
							<label class="col-sm-2 control-label">设备标签：</label>
							<span class="col-sm-7 control-label" name="keyWords" style="text-align: left;" ></span>
						</div>

						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">经度：</label>
							<span class="col-sm-7 control-label" name="lng" style="text-align: left;" ></span>
						</div>
						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">纬度：</label>
							<span class="col-sm-7 control-label" name="lat" style="text-align: left;" ></span>
						</div>
						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">描述：</label>
							<span class="col-sm-7 control-label" name="description" style="text-align: left;" ></span>
						</div>
						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">行政区划代码：</label>
							<span class="col-sm-7 control-label" name="districtCode" style="text-align: left;" ></span>
						</div>

						<div class="form-group has-feedback" >
							<label class="col-sm-2 control-label">设备封面：</label>
							<div class="col-sm-7">
								<div style="width: 80px;height: 80px;position: relative;">
									<img src="images/default_pic.png" id="devicePictureDetail"
										 style="height:80px;width: 80px;position: absolute;left:0;top:0;"/>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer" style="padding:5px 15px;">
					<button name="bid" class="btn btn-primary" style="display: none;">开始竞价</button>
					<button name="endbid" class="btn btn-primary" style="display: none;">结束竞价</button>
					<button name="check" class="btn btn-primary" style="display: none;">审核</button>
					<button class="btn btn-default" data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
  	</div>
  	
  	<div id="contents" class="container-fluid">
	  	<div class="panel panel-default">
	  		<div class="panel-body">
		    	<ul class="toolbar">
		        <li class="click" onclick="application.addModal()"><span><img src="../images/t01.png" /></span>添加</li>
		        <!--<li class="click" onclick="application.updateModal()"><span><img src="images/t02.png" /></span>修改</li>-->
		        <!--<li class="click" onclick="application.deleteModal()"><span><img src="images/t03.png" /></span>删除</li>-->
		        <!--<li class="click" onclick="application.updateState()"><span><img src="images/t04.png" /></span>审核通过</li>-->
		        <!--<li class="click" onclick="application.bid()"><span><img src="images/t05.png" /></span>竞价</li>-->
		       <!--  <li class="click" onclick="application.dataModal()"><span><img src="images/t04.png" /></span>查看</li> -->
		        </ul>

		  		<div class="input-group" class="col-md-4"> 
		            <span class="input-group-addon">搜索</span> 
		            <input id="searchInput" type="text" class="form-control" > 
		        </div> 
	  		</div>
		</div>
	  	
	    <div>
	   		<!-- <h4><strong>平台用户</strong></h4> -->
	    	<table id="applicationTable" class="table table-striped table-bordered"  >
	    		<thead>
	    			<tr>
	    				<th>编号</th>
		    			<th>名称</th>
		    			<th>设备状态</th>
						<th>地址</th>
		    			<th>底价</th>
		    			<th>标签</th>
		    			<th>行政区划代码</th>
		    			<th>拥有者</th>
						<th>状态</th>
		    		</tr>
	    		</thead>
	    		<tbody>
	    			
	    		</tbody>
	    	</table>
	    </div>
	   
    </div>
	
    <script type="text/javascript">
    	
    	$(function(){
			$("#searchInput").keyup( function() {
				$("#applicationTable").DataTable().draw();
			});
			application.autoComplete();
            $("[name='devicePicture0']").change(function(){
                xmTanUploadImg(this,$("#devicePictureImg")[0]);
            });
    	});
    	
    	$.fn.dataTable.ext.search.push(
			function( settings, data, dataIndex ) {
				var search = $("#searchInput").val();
				for(i in data){
					if(data[i].indexOf(search)>=0){
						return true;
					}
				}
				return false;
			}
		);

        var xmTanUploadImg = function(obj,img) {
            var file = obj.files[0];

            console.log(obj);console.log(file);
            console.log("file.size = " + file.size);  //file.size 单位为byte

            var reader = new FileReader();

            //读取文件过程方法
            reader.onloadstart = function (e) {
                console.log("开始读取....");
            }
            reader.onprogress = function (e) {
                console.log("正在读取中....");
            }
            reader.onabort = function (e) {
                console.log("中断读取....");
            }
            reader.onerror = function (e) {
                console.log("读取异常....");
            }
            reader.onload = function (e) {
                console.log("成功读取....");
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        var application={
    		rowid:null,
    		row:{},
    		table: $("#applicationTable").DataTable({
    			"bAutoWidth": false,
    			//"ajax": "user/personUerList",
    			"ajax":{
    				"url":"device/my",
    				"contentType": "application/json",
    				"data":function(d){
    					console.log(d);
    					return d.data;
    				}
    			},
    			"columnDefs": [
                	{	                          
                    	"defaultContent": "",
                        "targets": "_all"
                   	},
                   	{
                   		"targets" : 2,
						"render" : function(data, type, row) {
							if("O"==data){
								return "竞价中";
							}
							if("R"==data){
								return "维护中";
							}
							if("C"==data){
								return "未竞价";
							}
							return "未竞价";
						}
                   	},
                   	{
                   		"targets" : 0,
						"render" : function(data, type, row) {
                            return '<a style="cursor: pointer;">'+data+'</a>';
						}
                   	},
                    {
                        "targets" : 8,
                        "render" : function(data, type, row) {
                            if("N"==data){
                                return "未审核";
                            }
                            if("C"==data){
                                return "审核成功";
                            }
                            if("D"==data){
                                return "已删除";
                            }
                            return "已删除";
                        }
                    }
                ],	      
    			"columns":[
    				{"data":"id"},
    				{"data":"name"},
    				{"data":"deviceStatus"},
                    {"data":"address"},
    				{"data":"basePrice"},
    				{"data":"keyWords"},
    				{"data":"districtCode"},
    				{"data":"owner"},
                    {"data":"state"}
    			],
    			"bStateSave": true,
    			"oLanguage": {
					"sLengthMenu": "每页显示 _MENU_ 条记录",
				    "sZeroRecords": "<p>对不起，查询不到任何相关数据</p> <span onclick='application.addModal();' class='btn btn-default btn-xs'>新增</span>",
				    "sInfo": "当前显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
				    "sInfoEmtpy": "找不到相关数据",
				    "sInfoFiltered": "数据表中共为 _MAX_ 条记录)",
				    "sProcessing": "正在加载中...",
				    "sSearch": "搜索",
				    "sUrl": "", 
				    "oPaginate": {
				    	"sFirst":    "第一页",
				        "sPrevious": " 上一页 ",
				        "sNext":     " 下一页 ",
				        "sLast":     " 最后一页 "
				     }
				}, 
				"aLengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
				"bInfo": false,
				"bFilter": true,  //l-每页显示数量 f-过滤输入  t-表单Table i-信息  p-翻页 r-pRocessing
				"sDom": '<"top"i>rt<"bottom"pl><"clear">',
    		}),
    		reload:function(){
    			this.table.ajax.reload();
	    	},
	    	showKeySecret:function(v){
	    		var display, visibility;
	    		if(v){
	    			display="block"; 
	    			visibility="hidden";
	    		}else{
	    			display="none"; 
	    			visibility="visible";
	    		}
	    		$("#applicationForm div[name='appKeyDiv']").css("display", display);
	    		$("#applicationForm div[name='appSecretDiv']").css("display", display);
	    		$("#modal button[name='submit']").css("visibility", visibility);
	    	},
	    	dataModal:function(row){
	    		this.showKeySecret(true);
	    		for(var p in row){   
	    			$("#applicationForm input[name="+p+"]").val(row[p]);
	    		} 	
	    		$("#modal").modal('show');
	    	},
	    	getVal:function(formId){
	    		var app={};
	    		var form = $(formId).serializeArray();
	    		for(var input in form){
	    			if(form[input].value){
	    				app[form[input].name]=form[input].value;
	    			}
	    		}
	    		return app;
	    	},
	    	addModal:function(){
	    		$("#applicationForm input").val('');
	    		this.showKeySecret(false);
	    		$("#modal button[name='submit']").attr("onclick","application.add()");
	    		$("#modal").modal('show');
	    		$("#devicePictureImg").attr("src","images/add_img.png");
	    	},
	    	add:function(){
	    		var v = this.validate("#applicationForm");
	    		if(!v){
	    			return;
	    		}
//	    		v.deviceStatus = "W";
//	    		v.deviceType = "S";
//	    		$.ajax({
//	    			type:"post",
//	    			url:"device/new",
//	    			dataType:"json",
//	    			data:v,
//	    			success:function(data){
//	    				application.reload();
//	    				$("#modal").modal('hide');
//	    			}
//	    		})

                $("#applicationForm").ajaxSubmit({
                    url : "device/new",
                    type : 'POST',

					data:{
                        deviceStatus : "W",
                        deviceType : "S",
						state:"N"
					},
                    success : function(data) {
                        application.reload();
                        $("#modal").modal('hide');
                    },
                    error: function(data) {
                        alert("上传失败");
                    }
                });
	    	},
	    	updateModal:function(){
	    		if(!application.rowid){
	    			return;
	    		}
	    		var row = application.row;
	    		this.showKeySecret(false);
	    		for(var p in row){   
	    			$("#applicationForm input[name="+p+"]").val(row[p]);
	    		}
	    		$("#modal button[name='submit']").attr("onclick","application.update()");
	    		$("#modal").modal('show');

	    	},
	    	update:function(){
	    		var v = this.validate("#applicationForm");
	    		if(!v){
	    			return;
	    		}
	    		$.ajax({
	    			type:"post",
	    			url:"device/update",
	    			dataType:"json",
	    			data:v,
	    			success:function(data){
	    				application.reload();
	    				$("#modal").modal('hide');
	    			}
	    		});
	    	},
	    	updateState:function(row,state){
	    		if(!row){
	    			return;
	    		}
	    		$.ajax({
	    			type:"post",
	    			url:"device/update",
	    			dataType:"json",
	    			data:{
	    				id:row.id,
	    				state:state
	    			},
	    			success:function(data){
	    				application.reload();
	    				$("#detailModal").modal('hide');
	    			}
	    		});
	    	},
	    	deleteModal:function(){
	    		if(!application.rowid){
	    			return;
	    		}
	    		console.log(application.account);
	    		$("#confirmModal .confirm-content").html(application.rowid);
	    		$("#confirmModal button[name='submit']").attr("onclick","application.deleteApp()");
	    		$("#confirmModal").modal('show'); 
	    	},
	    	deleteApp:function(){
	    		$.post("device/delete", {deviceId:application.rowid}, function(data){
    				application.reload();
    				$("#confirmModal").modal('hide');
	    		}, "json");
	    	},
	    	validate:function(formId){
	    		var v = {};
	    		var inputs = $(formId + " input");
	    		for(var i=0; i<inputs.length; i++){
	    			var obj = inputs[i];
	    			if(!obj){
	    				continue;
	    			}
	    			var obj = inputs[i];
	    			var name = $(obj).attr('name');
	    			var val = $(obj).val();
	    			v[name]=val;
	    		}
	    		return v;
	    	},
	    	test:function(){
	    		console.log("test");
	    	},
	    	autoComplete:function(){
	    		$("#applicationForm input[name='keyWords']").autocomplete({
					  source: [ "学生", "上班族", "广场", "电梯口" ],
					  minLength:0
				}).focus(function() {
				    $(this).autocomplete("search", $(this).val());
				}); 
	    	},
	    	bid:function(){
	    		$.post("order/bid");
	    	},
            detail:function(row){
                for(var p in row){
                    $("#detailModal [name="+p+"]").text(row[p]);
                }
                debugger;
//                if(row.state){
//                    $("#detailModal [name='state']").text(stateRender(row.state));
//                }


                if(row.devicePictureUrls && row.devicePictureUrls.length>0){
                    $("#devicePictureDetail").attr("src",row.devicePictureUrls[0])
                        .off("click").click(function(){
                        window.open(row.devicePictureUrls[0]);
                    });
                }else{
                    $("#devicePictureDetail").off("click");
                }

                $("#detailModal").modal('show');
                if(row.deviceStatus == "O"){
                    $("[name='bidend']").off("click").click(function(){
                        //application.updateState(row,"C");
                    }).show();
                }else{
                    $("[name='bidend']").hide().off("click");
                }

					if(row.deviceStatus == "C"){
                    $("[name='bid']").off("click").click(function(){
                        //application.updateState(row,"C");
                    }).show();
                }else{
                    $("[name='bid']").hide().off("click");
                }

                if(row.state ="N"){
                    $("[name='check']").off("click").click(function(){
                        application.updateState(row,"C");
                    }).show();
                }else{
                    $("[name='check']").hide().off("click");
                }
			}
    	}
    	
//    	$('#applicationTable tbody').on('click', 'tr', function(){
// 	        if ($(this).hasClass('selected')) {
// 	            $(this).removeClass('selected');
// 	        } else {
// 	            $('#applicationTable').DataTable().$('tr.selected').removeClass('selected');
// 	            $(this).addClass('selected');
// 	        }
// 	        var data = $('#applicationTable').DataTable().row('.selected').data();
// 	        application.rowid = data.id;
// 	        application.row = data;
// 	        console.log(data);
// 	    });

        $('#applicationTable tbody').on('click', 'td', function(arg1){
            var data=$('#applicationTable').DataTable().row(this).data()
            if(arg1.currentTarget.cellIndex == 0){
                application.detail(data);
            }
        });
    
    </script>
    
  </body>
</html>
